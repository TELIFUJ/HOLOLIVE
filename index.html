<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>Hololive 卡片持有市值 v8</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg-page: #f3f4f6;
        --bg-card: #ffffff;
        --border-subtle: #e5e7eb;
        --text-main: #111827;
        --text-muted: #6b7280;
        --accent: #2563eb;
      }

      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          system-ui, sans-serif;
        background: var(--bg-page);
        color: var(--text-main);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
      }

      h1 {
        font-size: 1.4rem;
        margin: 0 0 4px 0;
      }

      .subtitle {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin: 0 0 12px 0;
      }

      .subtitle code {
        font-size: 0.8rem;
        background: #e5e7eb;
        padding: 1px 4px;
        border-radius: 4px;
      }

      .stat-bar {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 16px;
        font-size: 0.9rem;
      }

      .stat-item {
        background: var(--bg-card);
        border-radius: 8px;
        padding: 8px 10px;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
      }

      .stat-item strong {
        font-weight: 600;
      }

      @media (min-width: 768px) {
        .stat-bar {
          flex-direction: row;
          align-items: stretch;
        }
        .stat-item {
          flex: 1;
        }
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 16px;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 12px;
      }

      .toolbar-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 12px;
        align-items: center;
      }

      label {
        font-size: 0.85rem;
        color: var(--text-main);
      }

      input[type="text"],
      select,
      textarea {
        font-size: 0.85rem;
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        box-sizing: border-box;
      }

      textarea {
        width: 100%;
        resize: vertical;
        min-height: 80px;
      }

      button {
        font-size: 0.85rem;
        padding: 4px 10px;
        border-radius: 4px;
        border: none;
        background: var(--accent);
        color: #ffffff;
        cursor: pointer;
        white-space: nowrap;
      }

      button.secondary {
        background: #6b7280;
      }

      button:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .status {
        font-size: 0.85rem;
        color: var(--accent);
        margin-bottom: 8px;
      }

      .status-inline {
        font-size: 0.8rem;
        color: var(--accent);
        margin-left: 8px;
      }

      .page-info {
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .table-wrapper {
        overflow-x: auto;
        background: var(--bg-card);
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.1);
        margin-bottom: 8px;
      }

      table.data-table {
        width: 100%;
        min-width: 720px;
        border-collapse: collapse;
      }

      table.data-table thead {
        background: #e5e7eb;
      }

      table.data-table th,
      table.data-table td {
        padding: 6px 8px;
        border-bottom: 1px solid var(--border-subtle);
        font-size: 0.8rem;
      }

      table.data-table th {
        text-align: left;
        white-space: nowrap;
      }

      table.data-table tbody tr:nth-child(even) {
        background: #f9fafb;
      }

      table.data-table tbody tr:hover {
        background: #eff6ff;
      }

      td.numeric {
        text-align: right;
      }

      td.img-cell {
        text-align: center;
      }

      td.img-cell img {
        max-height: 80px;
        cursor: pointer;
      }

      td.links-cell {
        white-space: nowrap;
      }

      .link-btn {
        display: inline-block;
        padding: 2px 6px;
        margin-right: 4px;
        font-size: 0.75rem;
        border-radius: 999px;
        background: #f97316;
        color: #ffffff;
        text-decoration: none;
      }

      .link-btn:hover {
        background: #ea580c;
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        background: #e5e7eb;
        color: #111827;
      }

      .badge.r-osr {
        background: #f97316;
        color: #ffffff;
      }

      .badge.r-rr {
        background: #ef4444;
        color: #ffffff;
      }

      .badge.r-sr {
        background: #6366f1;
        color: #ffffff;
      }

      .badge.r-r {
        background: #10b981;
        color: #ffffff;
      }

      .badge.r-u {
        background: #06b6d4;
        color: #ffffff;
      }

      .badge.r-c {
        background: #9ca3af;
        color: #ffffff;
      }

      .badge.r-p {
        background: #e11d48;
        color: #ffffff;
      }

      .short-cell {
        color: #b91c1c;
        font-weight: 600;
      }

      .decklog-section {
        margin-top: 32px;
      }

      .decklog-section h2 {
        font-size: 1.1rem;
        margin-bottom: 4px;
      }

      .helper-text {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      .decklog-summary {
        font-size: 0.85rem;
        margin: 8px 0 12px 0;
      }

      .decklog-actions {
        margin-top: 8px;
        margin-bottom: 4px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .image-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .image-modal.active {
        display: flex;
      }

      .image-modal img {
        max-width: 90vw;
        max-height: 90vh;
        box-shadow: 0 0 16px rgba(0, 0, 0, 0.8);
        background: #ffffff;
      }

      @media (max-width: 768px) {
        table.data-table {
          min-width: 640px;
        }
        .toolbar {
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Hololive 卡片持有市值總覽</h1>
      <p class="subtitle">
        以 YUYU
        <strong>收購價</strong>
        估算市值；資料來源：
        <code>v_portfolio_positions_jpy_v8</code>
        （Supabase view）
      </p>

      <!-- 上方總覽數字 -->
      <div class="stat-bar">
        <div class="stat-item">
          <strong>全部持有市值（收購價）：</strong>
          ¥<span id="allTotalJpy">-</span>
          （約 NT$<span id="allTotalTwd">-</span>）
        </div>
        <div class="stat-item">
          <strong>目前列表（套用篩選後）：</strong>
          筆數 <span id="recordCount">-</span>｜
          張數 <span id="totalQty">-</span>｜
          市值 ¥<span id="totalMarketJpy">-</span>
          （約 NT$<span id="totalMarketTwd">-</span>）
        </div>
      </div>

      <!-- 篩選＋分頁控制列 -->
      <div class="toolbar">
        <div class="toolbar-group">
          <label>
            關鍵字：
            <input
              type="text"
              id="searchInput"
              placeholder="卡號／日文名稱"
            />
          </label>

          <label>
            系列：
            <select id="expansionFilter">
              <option value="">全部系列</option>
            </select>
          </label>

          <button id="reloadBtn">重新整理</button>
        </div>

        <div class="toolbar-group">
          <label>
            每頁顯示：
            <select id="pageSize">
              <option value="10">10 筆</option>
              <option value="20">20 筆</option>
              <option value="50">50 筆</option>
              <option value="100">100 筆</option>
            </select>
          </label>
          <span id="pageInfo" class="page-info">第 1 / 1 頁</span>
          <button id="prevPageBtn">上一頁</button>
          <button id="nextPageBtn">下一頁</button>
        </div>
      </div>

      <div id="status" class="status">初始化中...</div>

      <!-- 主持有列表 -->
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>卡號</th>
              <th>稀有度</th>
              <th>日文名稱</th>
              <th>系列</th>
              <th>圖片</th>
              <th>持有張數</th>
              <th>YUYU 收購價 (JPY)</th>
              <th>YUYU 販售價 (JPY)</th>
              <th>持有市值 (收購)</th>
              <th>YUYU</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <!-- Decklog 比對區塊 -->
      <section class="decklog-section">
        <h2>Decklog 牌組比對</h2>
        <p class="helper-text">
          步驟：① 在 Decklog 牌組頁面點你的「Decklog → JSON」書籤，讓網站把牌組轉成
          JSON 並複製到剪貼簿；② 把 JSON 貼在下面；③ 按「比對 Decklog」。
        </p>
        <textarea
          id="decklogInput"
          placeholder='例如：{"deck_id":"3671H","main":{"hBP01-001":1,...}}'
        ></textarea>

        <div class="decklog-actions">
          <button id="decklogBtn">比對 Decklog</button>
          <button id="decklogExportBtn" class="secondary">
            下載比對結果 CSV
          </button>
          <span id="decklogStatus" class="status-inline"></span>
        </div>

        <div id="decklogSummary" class="decklog-summary">
          尚未載入任何 Decklog 牌組。
        </div>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>卡號</th>
                <th>稀有度</th>
                <th>日文名稱</th>
                <th>圖片</th>
                <th>牌組需求</th>
                <th>目前持有</th>
                <th>缺少</th>
                <th>YUYU 收購價</th>
                <th>YUYU 販售價</th>
                <th>YUYU</th>
              </tr>
            </thead>
            <tbody id="deckCompareBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- 圖片放大 modal -->
    <div id="imageModal" class="image-modal">
      <img id="modalImage" src="" alt="card" />
    </div>

    <script src="main.js?v=10"></script>
  </body>
</html>
